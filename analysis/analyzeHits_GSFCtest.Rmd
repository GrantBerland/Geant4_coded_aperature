---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.5.2
  kernelspec:
    display_name: Python [conda env:py3] *
    language: python
    name: conda-env-py3-py
---

```{python}
# %matplotlib inline

import matplotlib.pyplot as plt
import numpy as np
import pandas as pd

from scipy.signal import fftconvolve, convolve

from util_fncs import makeMURA
```

```{python}

# This simulation run
E0      = 1700;       # keV
N_parts = 1e6;  # electrons

```

```{python}
data = pd.read_csv("../data/resultsFile_GSFCtest.csv", names=['E','det','i','j','x0','y0','z0']);
data.info()

detectors = np.unique(data.det);

plt.figure(); plt.grid(); plt.xlabel('Energy [keV]'); plt.ylabel('Counts');
h = plt.hist(data.E, bins=100)#, bins=np.logspace(np.log10(50), np.log10(300), 16));
plt.title("Energy Spectra", fontsize=14);

avg_image = np.zeros([16,16]);
for detID in detectors:
    sig = np.histogram2d(data.i[data.det == detID].values, data.j[data.det == detID].values, 
                        bins=[np.linspace(0,16,17),np.linspace(0,16,17)]);
    #plt.figure(figsize=(14,5));plt.subplot(1,2,1);c=plt.imshow(sig[0], cmap='Blues'); plt.colorbar(c);
    #plt.subplot(1,2,2); plt.imshow(fftconvolve(sig[0], decoder), cmap='Blues')
    avg_image += sig[0];
    
plt.figure(figsize=(14,5));
plt.subplot(1,2,1); plt.title("Raw Detector Image")
c=plt.imshow(avg_image, cmap='Blues');
plt.colorbar(c);

mask, decoder = makeMURA();

MF  = 1
rec_image1 = fftconvolve(avg_image - MF*np.mean(avg_image), decoder, mode='same')
rec_image1[rec_image1 < 0] = 0

decoder[decoder == -1] = -0.7059;
rec_image2 = fftconvolve(avg_image, decoder, mode='same')


plt.subplot(1,2,2);
c=plt.imshow(rec_image1, cmap='Blues');
plt.colorbar(c); plt.title("Method 0")


plt.figure(figsize=(14,5));
plt.subplot(1,2,1); plt.title("Raw Detector Image")
c=plt.imshow(avg_image, cmap='Blues');
plt.colorbar(c);

plt.subplot(1,2,2);
c=plt.imshow(rec_image2, cmap='Blues');
plt.colorbar(c); plt.title("Method 1");

print("\nWeird peak at %.2f keV?" % (h[1][np.argmax(h[0])]))
```

```{python}
# %matplotlib inline
from mpl_toolkits.mplot3d import Axes3D


plt.figure(); plt.grid(); plt.xlabel('Energy [keV]'); plt.ylabel('Counts');
h = plt.hist(data.E, bins=50)#, bins=np.logspace(np.log10(50), np.log10(300), 16));
plt.title("Energy Spectra", fontsize=14);


xlim = 10;
plt.figure(figsize=(6,6)); plt.grid();
plt.scatter(data.z0[data.x0 < xlim], data.y0[data.x0 < xlim]);
plt.axis('equal'); plt.xlabel('z'); plt.ylabel('y');

plt.figure();
plt.hist(data.x0);

print(data.x0[data.x0 < -7])
```
