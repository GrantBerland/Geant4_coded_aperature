---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.5.2
  kernelspec:
    display_name: Python [conda env:py3] *
    language: python
    name: conda-env-py3-py
---

```{python}
# %matplotlib inline

import matplotlib.pyplot as plt
import numpy as np
import pandas as pd
```

<!-- #region -->
# GSFC Electron Beam Flux and Energy Calculation

Let the nominal background noise on the detector be $N_{BG} = 20$ counts/det-s (to be refined with control data taken inside GSFC vacuum chamber), and the maximum detector count rate is $C_{max} = 60,000 ~cps$.

The Redlen M1770 CZT photon energy range is 50 - 300 keV. We will assume that electrons are less efficient at energy deposition than photons, such that we're interested in looking at electron final energies of 50 - 500 keV.

We would like a minimum number of electrons/bin to be approximately 10x as high as the background for sufficient statistics in each energy bin. This is the low end constraint. The upper end constraint is the minimum of the following: lowest intensity that the REF beam can achieve, $I_{min}$, or the maximum AXIS detector count rate, $C_{max}$.

The minimum intensity the REF electron generator can achieve is

$$I_{min} = 10^{-9} ~mA/cm^2 = 6 \times 10^6 ~e^-/s/cm^2$$

over the energy ranges of 35 keV - 1.7 MeV. The beam is simulated passing through the shielding and depositing in the detector in GEANT4. The simulated shileding electron flux attenuation response to a monoenergetic beam is  
   
$$\frac{I}{I_0} = m ~E + b$$
$$$$
$$m = 8\times10^{-4}~keV^{-1} ~~,~~ b = -0.725$$


where $E$ is the electron beam energy in units of keV. Typical $I/I_0$ values are $8.9\times10^{-4} - 7.0\times10^{-3}$ for energies of 1000 - 1700 keV. We aim to receive data in the following window:

$$Range = [10 \cdot N_{BG}~,~ 2/3\cdot C_{max}] \approx [200, 40000]~cps$$

<!-- #endregion -->

<!-- #region -->
## GEANT4 Simulation Setup


<img src="./GSFC_setup1.png" width="400" />
2'' beam diameter, isometric view

<img src="./GSFC_setup2.png" width="300" /> 
Top view
<img src="./GSFC_setup3.png" width="300" />
<!-- #endregion -->

```{python}
# "energy in keV": pandas dataframe
GSFC_data = {"1000": pd.read_csv("../data/resultsFile_GSFCtest_1000keV.csv", 
                                 names=['E','det','i','j','x0','y0','z0']),
             "1100": pd.read_csv("../data/resultsFile_GSFCtest_1100keV.csv", 
                                 names=['E','det','i','j','x0','y0','z0']),
             "1200": pd.read_csv("../data/resultsFile_GSFCtest_1200keV.csv", 
                                 names=['E','det','i','j','x0','y0','z0']),
             "1300": pd.read_csv("../data/resultsFile_GSFCtest_1300keV.csv", 
                                 names=['E','det','i','j','x0','y0','z0']),
             "1400": pd.read_csv("../data/resultsFile_GSFCtest_1400keV.csv", 
                                 names=['E','det','i','j','x0','y0','z0']),
             "1500": pd.read_csv("../data/resultsFile_GSFCtest_1500keV.csv", 
                                 names=['E','det','i','j','x0','y0','z0']),
             "1600": pd.read_csv("../data/resultsFile_GSFCtest_1600keV.csv", 
                                 names=['E','det','i','j','x0','y0','z0']),
             "1700": pd.read_csv("../data/resultsFile_GSFCtest_1700keV.csv", 
                                 names=['E','det','i','j','x0','y0','z0'])}

nSimulation = 1e6;
```

```{python}
# "energy in keV": pandas dataframe
GSFC_data_LR = {"1000": pd.read_csv("../data/resultsFile_GSFCtest_1000keV_LR.csv", 
                                 names=['E','det','i','j','x0','y0','z0']),
             "1100": pd.read_csv("../data/resultsFile_GSFCtest_1100keV_LR.csv", 
                                 names=['E','det','i','j','x0','y0','z0']),
             "1200": pd.read_csv("../data/resultsFile_GSFCtest_1200keV_LR.csv", 
                                 names=['E','det','i','j','x0','y0','z0']),
             "1300": pd.read_csv("../data/resultsFile_GSFCtest_1300keV_LR.csv", 
                                 names=['E','det','i','j','x0','y0','z0']),
             "1400": pd.read_csv("../data/resultsFile_GSFCtest_1400keV_LR.csv", 
                                 names=['E','det','i','j','x0','y0','z0']),
             "1500": pd.read_csv("../data/resultsFile_GSFCtest_1500keV_LR.csv", 
                                 names=['E','det','i','j','x0','y0','z0']),
             "1600": pd.read_csv("../data/resultsFile_GSFCtest_1600keV_LR.csv", 
                                 names=['E','det','i','j','x0','y0','z0']),
             "1700": pd.read_csv("../data/resultsFile_GSFCtest_1700keV_LR.csv", 
                                 names=['E','det','i','j','x0','y0','z0'])}

nSimulation_LR = 1e8;
```

```{python}
bins = np.logspace(np.log10(50), np.log10(500), 20);
bins = np.insert(bins, 0, 0);            # underflow
#bins = np.insert(bins, len(bins), 1500); # overflow

penFrac_LR = [];

for name in GSFC_data_LR.keys():
    
    plt.figure(figsize=(14,5)); plt.subplot(1,2,1); plt.grid();
    plt.hist(GSFC_data_LR[name].E, bins=50);
    plt.xlabel("Energy [keV]"); plt.ylabel("Counts");
    plt.title(r"E$_0$ = %s keV, total counts: %i" % (name, len(GSFC_data_LR[name])));
    
    plt.subplot(1,2,2); plt.grid();
    plt.hist(GSFC_data[name].E, bins=bins);
    plt.title("AXIS Bins");
    plt.xlabel("Energy [keV]"); plt.ylabel("Counts");
    
    penFrac_LR.append(len(GSFC_data_LR[name])/nSimulation_LR);
    
    print("E0 = %s keV %.3f%% electrons through shielding" % (name, 100*len(GSFC_data_LR[name])/nSimulation_LR))
    
```

```{python}
bins = np.logspace(np.log10(50), np.log10(500), 20);
bins = np.insert(bins, 0, 0);            # underflow
#bins = np.insert(bins, len(bins), 1500); # overflow

penFrac = [];

for name in GSFC_data.keys():
    
    plt.figure(figsize=(14,5)); plt.subplot(1,2,1); plt.grid();
    plt.hist(GSFC_data[name].E, bins=50);
    plt.xlabel("Energy [keV]"); plt.ylabel("Counts");
    plt.title(r"E$_0$ = %s keV, total counts: %i" % (name, len(GSFC_data[name])));
    
    plt.subplot(1,2,2); plt.grid();
    plt.hist(GSFC_data[name].E, bins=bins);
    plt.title("AXIS Bins");
    plt.xlabel("Energy [keV]"); plt.ylabel("Counts");
    
    penFrac.append(len(GSFC_data[name])/nSimulation);
    
    print("E0 = %s keV %.3f%% electrons through shielding" % (name, 100*len(GSFC_data[name])/nSimulation))
    
```

```{python}
I                 = 6e6; # electrons/cm^2-sec
integrationPeriod = 1;   # sec

m = 0.0008;
b = -0.725;

energyArray = [1000, 1100, 1200, 1300, 1400, 1500, 1600, 1700]; # keV

plt.figure(figsize=(14,5)); plt.subplot(1,2,1); plt.grid();
#plt.plot(energyArray, np.multiply(penFrac, 100), '.', label='Geant Data, n=10$^6$');
plt.plot(energyArray[0:-1], np.multiply(penFrac_LR[0:-1], 100), '.', label='Geant Data, n=10$^8$');
plt.xlabel("Beam Energy [keV]", fontsize=12);
plt.ylabel("Beam Flux Penetration [%]", fontsize=12);
plt.plot(energyArray, np.multiply(energyArray,m) + b, label='Linear Fit');
plt.legend();

plt.subplot(1,2,2); plt.grid();
#plt.plot(energyArray, np.multiply(penFrac, I*integrationPeriod), '.',    label='Geant Data, n=10$^6$');
plt.plot(energyArray[0:-1], np.multiply(penFrac_LR[0:-1], I*integrationPeriod), '.', label='Geant Data, n=10$^8$');
plt.xlabel("Beam Energy [keV]", fontsize=12);
plt.ylabel("Detector Count Rate [cps]\n(all energy bins)", fontsize=12);
plt.suptitle("AXIS Shielding Response",fontsize=14);

plt.hlines(200, min(energyArray), max(energyArray), label='C$_{min}$');
plt.hlines(40000, min(energyArray), max(energyArray), label='C$_{max}$'); plt.legend();
```

```{python}
data = pd.read_csv("../data/resultsFile_GSFCtest_1700keV.csv", names=['E','det','i','j','x0','y0','z0']);
#data.info()

detectors = np.unique(data.det);

plt.figure(figsize=(14,5)); plt.grid(); plt.xlabel('Energy [keV]'); plt.ylabel('Counts'); plt.subplot(1,2,1)
h = plt.hist(data.E, bins=100)#, bins=np.logspace(np.log10(50), np.log10(300), 16));
plt.title("Energy Spectra", fontsize=14);

avg_image = np.zeros([16,16]);
for detID in detectors:
    sig = np.histogram2d(data.i[data.det == detID].values, data.j[data.det == detID].values, 
                        bins=[np.linspace(0,16,17),np.linspace(0,16,17)]);
    #plt.figure(figsize=(14,5));plt.subplot(1,2,1);c=plt.imshow(sig[0], cmap='Blues'); plt.colorbar(c);
    #plt.subplot(1,2,2); plt.imshow(fftconvolve(sig[0], decoder), cmap='Blues')
    avg_image += sig[0];
    
plt.subplot(1,2,2);
plt.title("Raw Detector Image")
c=plt.imshow(avg_image, cmap='Blues');
plt.colorbar(c);
```
