---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.5.2
  kernelspec:
    display_name: Python [conda env:py3] *
    language: python
    name: conda-env-py3-py
---

```{python}
# %matplotlib inline

import matplotlib.pyplot as plt
import numpy as np
import pandas as pd

from scipy.signal import fftconvolve, convolve

from util_fncs import makeMURA
```

# Source radioactivity as of 6/7/2020

A$_{Ba-133}$ = $3.27 \times 10^5$ dps

A$_{Cs-137}$ = $3.488 \times 10^5$ dps

A$_{Co-57}$  = $1.125 \times 10^5$ dps

A$_{Eu-152}$ = $3.26 \times 10^4$ dps


# Linepair Test Notes

Spatial frequency for the linepair test is defined as

$$\frac{1}{(2\times \text{line width}) ~\text{mm}} = X ~~\text{lp/mm}$$


# Simulation Setup

Source-detector distance: 50 cm

Environment: vacuum

Linepairs: 0.5 lp/mm

Source: Co-57

```{python}
# The below activity is in decompositions per second [dps] across the spectra and modality of 
# beta and gamma emissions.

A_Ba = 3.27e5;
A_Cs = 3.488e5;
A_Co = 1.125e5;
A_Eu = 3.26e4;

plt.figure(); plt.grid();
plt.bar(["Barium-133","Cesium-137","Cobalt-57","Europium-152"],[A_Ba, A_Cs, A_Co, A_Eu])
plt.ylabel("Radioactivity [dps]", fontsize=14); 
plt.xlabel("Element-Isotope", fontsize=14);


simDecays = 1e7;

print("Simulated %.2f sec exposure with Co-57 source" % (simDecays / A_Co))
```

```{python}
#data = pd.read_csv("../data/ptSource_test.csv", names=['E','det','i','j','x0','y0','z0']);
#data = pd.read_csv("../data/circularSource_test.csv", names=['E','det','i','j','x0','y0','z0']);
#data = pd.read_csv("../data/uniformPhiSource_test.csv", names=['E','det','i','j','x0','y0','z0']);
data = pd.read_csv("../data/pinhole_test4.csv", names=['E','det','i','j','x0','y0','z0']);


data.info()

data = data[np.logical_and(data.E > 50 , data.E < 300)];

data.info()

detectors = np.unique(data.det);

#mask, decoder = makeMURA();
decoder = np.load("NTHT_decoder.npy");

plt.figure(); plt.grid(); plt.xlabel('Energy [keV]'); plt.ylabel('Counts');
plt.hist(data.E, bins=np.logspace(np.log10(50), np.log10(300), 16));
plt.title("Energy Spectra", fontsize=14);

avg_image = np.zeros([16,16]);
for detID in detectors:
    sig = np.histogram2d(data.i[data.det == detID].values, data.j[data.det == detID].values, 
                        bins=[np.linspace(0,16,17),np.linspace(0,16,17)]);
    plt.figure(figsize=(14,5));plt.subplot(1,2,1);c=plt.imshow(sig[0], cmap='Blues'); plt.colorbar(c);
    plt.subplot(1,2,2); c=plt.imshow(fftconvolve(sig[0], decoder), cmap='Blues'); plt.colorbar(c);
    
    avg_image += sig[0];
    
    #avg_image += np.random.poisson(lam=1000, size=[16,16]);
    
plt.figure(figsize=(14,5));
plt.subplot(1,2,1); plt.title("Raw Detector Image")
c=plt.imshow(avg_image, cmap='Blues');
plt.colorbar(c);


MF  = 1
rec_image1 = fftconvolve(avg_image - MF*np.mean(avg_image), decoder, mode='same')
rec_image1[rec_image1 < 0] = 0

decoder[decoder == -1] = -0.7059;
decoder[decoder == -1] = -0.7059;
rec_image2 = fftconvolve(avg_image, decoder, mode='same')
#rec_image2[rec_image2 < 0] = 0;

plt.subplot(1,2,2);
c=plt.imshow(rec_image1, cmap='Blues');
plt.colorbar(c); plt.title("Method 0")


plt.figure(figsize=(14,5));
plt.subplot(1,2,1); plt.title("Raw Detector Image")
c=plt.imshow(avg_image, cmap='Blues');
plt.colorbar(c);

plt.subplot(1,2,2);
c=plt.imshow(rec_image2, cmap='Blues');
plt.colorbar(c); plt.title("Method 1");
```

```{python}
data = pd.read_csv("../data/pinhole_test5.csv", names=['E','det','i','j','x0','y0','z0']);

data.info()

detectors = np.unique(data.det);

plt.figure(); plt.grid(); plt.xlabel('Energy [keV]'); plt.ylabel('Counts');
plt.hist(data.E, bins=np.logspace(np.log10(50), np.log10(300), 16));
plt.title("Energy Spectra", fontsize=14);

avg_image = np.zeros([16,16]);
for detID in detectors:
    sig = np.histogram2d(data.i[data.det == detID].values, data.j[data.det == detID].values, 
                        bins=[np.linspace(0,16,17),np.linspace(0,16,17)]);
    plt.figure(figsize=(14,5));plt.subplot(1,2,1);c=plt.imshow(sig[0], cmap='Blues'); plt.colorbar(c);
    plt.title("Detector %i" % detID);
    #plt.subplot(1,2,2); plt.imshow(fftconvolve(sig[0], decoder), cmap='Blues')
    avg_image += sig[0];
    
plt.figure(figsize=(14,5));
plt.subplot(1,2,1); plt.title("Raw Detector Image")
c=plt.imshow(avg_image, cmap='Blues');
plt.colorbar(c);
```

```{python}
data.head()

print(np.unique(data.det.values))
```

```{python}
plt.figure(figsize=(8,6));
c=plt.imshow(rec_image1);
plt.colorbar(c);

B = np.sum(rec_image1[14,:])
C_arr = np.zeros([len(rec_image1)**2, 1]);
for i in range(0, len(rec_image1)):
    for j in range(0, len(rec_image1)):
        S = np.sum(rec_image1[i,:]);
        B = np.sum(rec_image1[j,:]);
        C_arr[i*len(rec_image1)+j,:] = (S - B)/B

plt.figure(figsize=(5.6,4)); plt.grid();
plt.plot(C_arr); plt.ylabel('Contrast'); plt.xlabel('Index');
```

## Contrast calculation
The contrast can be found from
$$C = \frac{S-B}{B}$$
where $S$ is the signal strength and $B$ is the background strength.
